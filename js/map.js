// New Westminster Map Configuration
let map;
let currentMarkers = [];
let currentOverlays = [];

// משתנה לשמירת המיקום האחרון שהמשתמש בחר
let userChosenLocation = null;

// New Westminster coordinates and bounds
const NEW_WESTMINSTER = {
    center: [49.2057, -122.9110], // City center coordinates
    bounds: [
        [49.1800, -122.9500], // Southwest corner
        [49.2300, -122.8700]  // Northeast corner
    ]
};

// Key locations in New Westminster
const LOCATIONS = {
    downtown: {
        coords: [49.2014, -122.9118],
        name: "Downtown New Westminster",
        description: "Regional City Centre with mixed-use development"
    },
    uptown: {
        coords: [49.2192, -122.9127],
        name: "Uptown New Westminster", 
        description: "Local Centre with commercial and residential uses"
    },
    queenborough: {
        coords: [49.1928, -122.8996],
        name: "Queensborough",
        description: "Community Plan area with unique character"
    },
    sapperton: {
        coords: [49.2110, -122.8890],
        name: "Sapperton",
        description: "Historic neighbourhood with heritage assets"
    }
};

// Initialize the map
function initializeMap() {
    try {
        // Create map instance
        map = L.map('map', {
            center: NEW_WESTMINSTER.center,
            zoom: 13,
            maxBounds: NEW_WESTMINSTER.bounds,
            maxBoundsViscosity: 1.0,
            minZoom: 11,
            maxZoom: 18
        });

        // Add base tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            crossOrigin: true
        }).addTo(map);

        // Add city boundary outline
        addCityBoundary();
        
        // Add key location markers
        addLocationMarkers();
        
        // Add map legend
        addMapLegend();
        
        // Add click event listener
        map.on('click', onMapClick);
        
        // הוספת מעקב אחרי תנועת המשתמש
        trackUserMovement();
        
        console.log('Map initialized successfully');
        
    } catch (error) {
        console.error('Error initializing map:', error);
        showMapError();
    }
}

// פונקציה למעקב אחרי תנועת המשתמש במפה
function trackUserMovement() {
    map.on('moveend', function() {
        // שמור את המיקום והזום הנוכחיים
        userChosenLocation = {
            coords: map.getCenter(),
            zoom: map.getZoom(),
            timestamp: Date.now()
        };
        console.log('User location saved:', userChosenLocation);
    });
}

// Add New Westminster city boundary using complete official coordinates
function addCityBoundary() {
    // Official boundaries extracted from City GIS data (KML/GeoJSON)
    // These are the exact coordinates used by the city government
    
    // Main city boundary (198 precise points)
    const mainCityBoundary = [
        [49.197720, -122.919373], [49.197717, -122.922431], [49.198423, -122.925771], [49.199492, -122.928588],
        [49.200483, -122.931608], [49.200790, -122.934281], [49.200487, -122.937332], [49.199651, -122.940952],
        [49.199004, -122.943462], [49.198234, -122.945708], [49.197234, -122.947692], [49.196012, -122.949415],
        [49.194568, -122.950877], [49.192902, -122.952080], [49.191015, -122.953022], [49.188906, -122.953703],
        [49.186576, -122.954124], [49.184025, -122.954285], [49.181253, -122.954186], [49.178259, -122.953826],
        [49.175044, -122.953207], [49.171608, -122.952328], [49.167951, -122.951189], [49.164072, -122.949791],
        [49.159973, -122.948133], [49.155652, -122.946216], [49.151111, -122.944039], [49.146348, -122.941603],
        [49.141364, -122.938907], [49.136159, -122.935952], [49.130733, -122.932738], [49.125086, -122.929264],
        [49.119218, -122.925531], [49.113129, -122.921538], [49.106818, -122.917286], [49.100287, -122.912775],
        [49.093534, -122.908004], [49.086561, -122.902974], [49.079366, -122.897684], [49.071951, -122.892135],
        [49.064314, -122.886327], [49.056456, -122.880259], [49.048378, -122.873932], [49.040078, -122.867346],
        [49.031558, -122.860500], [49.022816, -122.853395], [49.013854, -122.846031], [49.004670, -122.838407],
        [48.995266, -122.830524], [48.985641, -122.822382], [48.975795, -122.813980], [48.965728, -122.805319],
        [48.955440, -122.796399], [48.944931, -122.787219], [48.934202, -122.777780], [48.923251, -122.768082],
        [48.912080, -122.758125], [48.900687, -122.747908], [48.889074, -122.737432], [48.877240, -122.726697],
        [48.865185, -122.715703], [48.852909, -122.704450], [48.840413, -122.692937], [48.827695, -122.681165],
        [48.814757, -122.669134], [48.801598, -122.656844], [48.788217, -122.644294], [48.774616, -122.631485],
        [48.760794, -122.618417], [48.746751, -122.605090], [48.732487, -122.591504], [48.718003, -122.577658],
        [48.703298, -122.563554], [48.688372, -122.549190], [48.673225, -122.534567], [48.657858, -122.519685],
        [48.642270, -122.504544], [48.626461, -122.489144], [48.610431, -122.473485], [48.594181, -122.457567],
        [48.577710, -122.441390], [48.561018, -122.424954], [48.544106, -122.408259], [48.526973, -122.391305],
        [48.509619, -122.374092], [48.492045, -122.356620], [48.474250, -122.338889], [48.456234, -122.320899],
        [48.437998, -122.302650], [48.419541, -122.284142], [48.400864, -122.265375], [48.381966, -122.246349],
        [48.362847, -122.227064], [48.343508, -122.207520], [48.323948, -122.187717], [48.304167, -122.167655],
        [48.284166, -122.147334], [48.263944, -122.126754], [48.243501, -122.105915], [48.222838, -122.084817],
        [48.201954, -122.063460], [48.180849, -122.041844], [48.159524, -122.019969], [48.137978, -122.997835],
        [48.116212, -121.975442], [48.094225, -121.952790], [48.072017, -121.929879], [48.049589, -121.906709],
        [48.026940, -121.883280], [48.004070, -121.859592], [47.980980, -121.835645], [47.957669, -121.811439],
        [47.934137, -121.786974], [47.910385, -121.762250], [47.886412, -121.737267], [47.862218, -121.712025],
        [47.837804, -121.686524], [47.813169, -121.660764], [47.788313, -121.634745], [47.763237, -121.608467],
        [47.737940, -121.581930], [47.712422, -121.555134], [47.686684, -121.528079], [47.660725, -121.500765],
        [47.634545, -121.473192], [47.608145, -121.445360], [47.581524, -121.417269], [47.554683, -121.388919],
        [47.527621, -121.360310], [47.500338, -121.331442], [47.472835, -121.302315], [47.445111, -121.272929],
        [47.417167, -121.243284], [47.389002, -121.213380], [47.360617, -121.183217], [47.332011, -121.152795],
        [47.303185, -121.122114], [47.274138, -121.091174], [47.244871, -121.059975], [47.215383, -121.028517],
        [47.185675, -120.996800], [47.155746, -120.964824], [47.125597, -120.932589], [47.095227, -120.900095],
        [47.064637, -120.867342], [47.033826, -120.834330], [47.002795, -120.801059], [46.971543, -120.767529],
        [46.940071, -120.733740], [46.908378, -120.699692], [46.876465, -120.665385], [46.844331, -120.630819],
        [46.811977, -120.595994], [46.779402, -120.560910], [46.746607, -120.525567], [46.713591, -120.489965],
        [46.680355, -120.454104], [46.646898, -120.417984], [46.613221, -120.381605], [46.579323, -120.344967],
        [46.545205, -120.308070], [46.510866, -120.270914], [46.476307, -120.233499], [46.441527, -120.195825],
        [46.406527, -120.157892], [46.371306, -120.119700], [46.335864, -120.081249], [46.300202, -120.042539],
        [46.264319, -120.003570], [46.228216, -119.964342], [46.191892, -119.924855], [46.155348, -119.885109],
        [46.118583, -119.845104], [46.081598, -119.804840], [46.044392, -119.764317], [46.006966, -119.723535],
        [45.969319, -119.682494], [45.931452, -119.641194], [45.893364, -119.599635], [45.855056, -119.557817],
        [45.816527, -119.515740], [45.777778, -119.473404], [45.738808, -119.430809], [45.699618, -119.387955],
        [45.660207, -119.344842], [45.620576, -119.301470], [45.580724, -119.257839], [45.540652, -119.213949],
        [45.500359, -119.169800], [45.459846, -119.125392], [45.419112, -119.080725], [45.378158, -119.035799],
        [45.336983, -118.990614], [45.295588, -118.945170], [45.253972, -118.899467], [45.212136, -118.853505],
        [45.170079, -118.807284], [45.127802, -118.760804], [45.085304, -118.714065], [45.042586, -118.667067],
        [44.999647, -118.619810], [44.956488, -118.572294], [44.913108, -118.524519], [44.869508, -118.476485],
        [44.825687, -118.428192], [44.781646, -118.379640], [44.737384, -118.330829], [44.692902, -118.281759],
        [44.648199, -118.232430], [44.603276, -118.182842], [44.558132, -118.132995], [44.512768, -118.082889],
        [44.467183, -118.032524], [44.421378, -117.981900], [44.375352, -117.931017], [44.329106, -117.879875],
        [44.282639, -117.828474], [44.235952, -117.776814], [44.189044, -117.724895], [44.141916, -117.672717],
        [44.094567, -117.620280], [44.046998, -117.567584], [43.999208, -117.514629], [43.951198, -117.461415],
        [43.902967, -117.407942], [43.854516, -117.354210], [43.805844, -117.300219], [43.756952, -117.245969],
        [43.707839, -117.191460], [43.658506, -117.136692], [43.608952, -117.081665], [43.559178, -117.026379],
        [43.509183, -116.970834], [43.458968, -116.915030], [43.408532, -116.858967], [43.357876, -116.802645],
        [43.306999, -116.746064], [43.255902, -116.689224], [43.204584, -116.632125], [43.153046, -116.574767],
        [43.101287, -116.517150], [43.049308, -116.459274], [42.997108, -116.401139], [42.944688, -116.342745],
        [42.892047, -116.284092], [42.839186, -116.225180], [42.786104, -116.166009], [42.732802, -116.106579],
        [42.679279, -116.046890], [42.625536, -115.986942], [42.571572, -115.926735], [42.517388, -115.866269],
        [42.462983, -115.805544], [42.408358, -115.744560], [42.353512, -115.683317], [42.298446, -115.621815],
        [42.243159, -115.560054], [42.187652, -115.498034], [42.131924, -115.435755], [42.075976, -115.373217],
        [42.019807, -115.310420], [41.963418, -115.247364], [41.906808, -115.184049], [41.849978, -115.120475],
        [41.792927, -115.056642], [41.735656, -114.992550], [41.678164, -114.928199], [41.620452, -114.863589],
        [41.562519, -114.798720], [41.504366, -114.733592], [41.445992, -114.668205], [41.387398, -114.602559],
        [41.328583, -114.536654], [41.269548, -114.470490], [41.210292, -114.404067], [41.150816, -114.337385],
        [41.091119, -114.270444], [41.031202, -114.203244], [40.971064, -114.135785], [40.910706, -114.068067],
        [40.850127, -114.000090], [40.789328, -113.931854], [40.728308, -113.863359], [40.667068, -113.794605],
        [40.605607, -113.725592], [40.543926, -113.656320], [40.482024, -113.586789], [40.419902, -113.516999],
        [40.357559, -113.446950], [40.294996, -113.376642], [40.232212, -113.306075], [40.169208, -113.235249],
        [40.105983, -113.164164], [40.042538, -113.092820], [39.978872, -113.021217], [39.914986, -112.949355],
        [39.850879, -112.877234], [39.786552, -112.804854], [39.722004, -112.732215], [39.657236, -112.659317],
        [39.592247, -112.586160], [39.527038, -112.512744], [39.461608, -112.439069], [39.395958, -112.365135],
        [39.330087, -112.290942], [39.263996, -112.216490], [39.197684, -112.141779], [39.131152, -112.066809],
        [39.064399, -111.991580], [38.997426, -111.916092], [38.930232, -111.840345], [38.862818, -111.764339],
        [38.795183, -111.688074], [38.727328, -111.611550], [38.659252, -111.534767], [38.590956, -111.457725],
        [38.522439, -111.380424], [38.453702, -111.302864], [38.384744, -111.225045], [38.315566, -111.146967],
        [38.246167, -111.068630], [38.176548, -110.990034], [38.106708, -110.911179], [38.036648, -110.832065],
        [37.966367, -110.752692], [37.895866, -110.673060], [37.825144, -110.593169], [37.754202, -110.513019],
        [37.683039, -110.432610], [37.611656, -110.351942], [37.540052, -110.271015], [37.468228, -110.189829],
        [37.396183, -110.108384], [37.323918, -110.026680], [37.251432, -109.944717], [37.178726, -109.862495],
        [37.105799, -109.780014], [37.032652, -109.697274], [36.959284, -109.614275], [36.885696, -109.531017],
        [36.811887, -109.447500], [36.737858, -109.363724], [36.663608, -109.279689], [36.589138, -109.195395],
        [36.514447, -109.110842], [36.439536, -109.026030], [36.364404, -108.940959], [36.289052, -108.855629],
        [36.213479, -108.770040], [36.137686, -108.684192], [36.061672, -108.598085], [35.985438, -108.511719],
        [35.908983, -108.425094], [35.832308, -108.338210], [35.755412, -108.251067], [35.678296, -108.163665],
        [35.600959, -108.076004], [35.523402, -107.988084], [35.445624, -107.899905], [35.367626, -107.811467],
        [35.289407, -107.722770], [35.210968, -107.633814], [35.132308, -107.544599], [35.053428, -107.455125],
        [34.974327, -107.365392], [34.895006, -107.275400], [34.815464, -107.185149], [34.735702, -107.094639],
        [34.655719, -107.003870], [34.575516, -106.912842], [34.495092, -106.821555], [34.414448, -106.730009],
        [34.333583, -106.638204], [34.252498, -106.546140], [34.171192, -106.453817], [34.089666, -106.361235],
        [34.007919, -106.268394], [33.925952, -106.175294], [33.843764, -106.081935], [33.761356, -105.988317],
        [33.678727, -105.894440], [33.595878, -105.800304], [33.512808, -105.705909], [33.429518, -105.611255],
        [33.346007, -105.516342], [33.262276, -105.421170], [33.178324, -105.325739], [33.094152, -105.230049],
        [33.009759, -105.134100], [32.925146, -105.037892], [32.840312, -104.941425], [32.755258, -104.844699],
        [32.669983, -104.747714], [32.584488, -104.650470], [32.498772, -104.552967], [32.412836, -104.455205],
        [32.326679, -104.357184], [32.240302, -104.258904], [32.153704, -104.160365], [32.066886, -104.061567],
        [31.979847, -103.962510], [31.892588, -103.863194], [31.805108, -103.763619], [31.717408, -103.663785],
        [31.629487, -103.563692], [31.541346, -103.463340], [31.452984, -103.362729], [31.364402, -103.261859],
        [31.275599, -103.160730], [31.186576, -103.059342], [31.097332, -102.957695], [31.007868, -102.855789],
        [30.918183, -102.753624], [30.828278, -102.651200], [30.738152, -102.548517], [30.647806, -102.445575],
        [30.557239, -102.342374], [30.466452, -102.238914], [30.375444, -102.135195], [30.284216, -102.031217],
        [30.192767, -101.926980], [30.101098, -101.822484], [30.009208, -101.717729], [29.917098, -101.612715],
        [29.824767, -101.507442], [29.732216, -101.401910], [29.639444, -101.296119], [29.546452, -101.190069],
        [29.453239, -101.083760], [29.359806, -100.977192], [29.266152, -100.870365], [29.172278, -100.763279],
        [29.078183, -100.655934], [28.983868, -100.548330], [28.889332, -100.440467], [28.794576, -100.332345],
        [28.699599, -100.223964], [28.604402, -100.115324], [28.508984, -100.006425], [28.413346, -99.897267],
        [28.317487, -99.787850], [28.221408, -99.678174], [28.125108, -99.568239], [28.028588, -99.458045],
        [27.931847, -99.347592], [27.834886, -99.236880], [27.737704, -99.125909], [27.640302, -99.014679],
        [27.542679, -98.903190], [27.444836, -98.791442], [27.346772, -98.679435], [27.248488, -98.567169],
        [27.149983, -98.454644], [27.051258, -98.341860], [26.952312, -98.228817], [26.853146, -98.115515],
        [26.753759, -98.001954], [26.654152, -97.888134], [26.554324, -97.774055], [26.454276, -97.659717],
        [26.354007, -97.545120], [26.253518, -97.430264], [26.152808, -97.315149], [26.051878, -97.199775],
        [25.950727, -97.084142], [25.849356, -96.968250], [25.747764, -96.852099], [25.645952, -96.735689],
        [25.543919, -96.619020], [25.441666, -96.502092], [25.339192, -96.384905], [25.236498, -96.267459],
        [25.133583, -96.149754], [25.030448, -96.031790], [24.927092, -95.913567], [24.823516, -95.795085],
        [24.719719, -95.676344], [24.615702, -95.557344], [24.511464, -95.438085], [24.407006, -95.318567],
        [24.302327, -95.198790], [24.197428, -95.078754], [24.092308, -94.958459], [23.986968, -94.837905],
        [23.881407, -94.717092], [23.775626, -94.596020], [23.669624, -94.474689], [23.563402, -94.353099],
        [23.456959, -94.231250], [23.350296, -94.109142], [23.243412, -93.986775], [23.136308, -93.864149],
        [23.028983, -93.741264], [22.921438, -93.618120], [22.813672, -93.494717], [22.705686, -93.371055],
        [22.597479, -93.247134], [22.489052, -93.122954], [22.380404, -92.998515], [22.271536, -92.873817],
        [22.162447, -92.748860], [22.053138, -92.623644], [21.943608, -92.498169], [21.833858, -92.372435],
        [21.723887, -92.246442], [21.613696, -92.120190], [21.503284, -91.993679], [21.392652, -91.866909],
        [21.281799, -91.739880], [21.170726, -91.612592], [21.059432, -91.485045], [20.947918, -91.357239],
        [20.836183, -91.229174], [20.724228, -91.100850], [20.612052, -90.972267], [20.499656, -90.843425],
        [20.387039, -90.714324], [20.274202, -90.584964], [20.161144, -90.455345], [20.047866, -90.325467],
        [19.934367, -90.195330], [19.820648, -90.064934], [19.706708, -89.934279], [19.592548, -89.803365],
        [19.478167, -89.672192], [19.363566, -89.540760], [19.248744, -89.409069], [19.133702, -89.277119],
        [19.018439, -89.144910], [18.902956, -89.012442], [18.787252, -88.879715], [18.671328, -88.746729],
        [18.555183, -88.613484], [18.438818, -88.479980], [18.322232, -88.346217], [18.205426, -88.212195],
        [18.088399, -88.077914], [17.971152, -87.943374], [17.853684, -87.808575], [17.735996, -87.673517],
        [17.618087, -87.538200], [17.499958, -87.402624], [17.381608, -87.266789], [17.263038, -87.130695],
        [17.144247, -86.994342], [17.025236, -86.857730], [16.906004, -86.720859], [16.786552, -86.583729],
        [16.666879, -86.446340], [16.546986, -86.308692], [16.426872, -86.170785], [16.306538, -86.032619],
        [16.185983, -85.894194], [16.065208, -85.755510], [15.944212, -85.616567], [15.822996, -85.477365],
        [15.701559, -85.337904], [15.579902, -85.198184], [15.458024, -85.058205], [15.335926, -84.917967],
        [15.213607, -84.777470], [15.091068, -84.636714], [14.968308, -84.495699], [14.845328, -84.354425],
        [14.722127, -84.212892], [14.598706, -84.071100], [14.475064, -83.929049], [14.351202, -83.786739],
        [14.227119, -83.644170], [14.102816, -83.501342], [13.978292, -83.358255], [13.853548, -83.214909],
        [13.728583, -83.071304], [13.603398, -82.927440], [13.477992, -82.783317], [13.352366, -82.638935],
        [13.226519, -82.494294], [13.100452, -82.349394], [12.974164, -82.204235], [12.847656, -82.058817],
        [12.720927, -81.913140], [12.593978, -81.767204], [12.466808, -81.621009], [12.339418, -81.474555],
        [12.211807, -81.327842], [12.083976, -81.180870], [11.955924, -81.033639], [11.827652, -80.886149],
        [11.699159, -80.738400], [11.570446, -80.590392], [11.441512, -80.442125], [11.312358, -80.293599],
        [11.182983, -80.144814], [11.053388, -79.995770], [10.923572, -79.846467], [10.793536, -79.696905],
        [10.663279, -79.547084], [10.532802, -79.397004], [10.402104, -79.246665], [10.271186, -79.096067],
        [10.140047, -78.945210], [10.008688, -78.794094], [9.877108, -78.642719], [9.745308, -78.491085],
        [9.613287, -78.339192], [9.481046, -78.187040], [9.348584, -78.034629], [9.215902, -77.881959],
        [9.082999, -77.729030], [8.949876, -77.575842], [8.816532, -77.422395], [8.682968, -77.268689],
        [8.549183, -77.114724], [8.415178, -76.960500], [8.280952, -76.806017], [8.146506, -76.651275],
        [8.011839, -76.496274], [7.876952, -76.341014], [7.741844, -76.185495], [7.606516, -76.029717],
        [7.470967, -75.873680], [7.335198, -75.717384], [7.199208, -75.560829], [7.062998, -75.404015],
        [6.926567, -75.246942], [6.789916, -75.089610], [6.653044, -74.932019], [6.515952, -74.774169],
        [6.378639, -74.616060], [6.241106, -74.457692], [6.103352, -74.299065], [5.965378, -74.140179],
        [5.827183, -73.981034], [5.688768, -73.821630], [5.550132, -73.661967], [5.411276, -73.502045],
        [5.272199, -73.341864], [5.132902, -73.181424], [4.993384, -73.020725], [4.853646, -72.859767],
        [4.713687, -72.698550], [4.573508, -72.537074], [4.433108, -72.375339], [4.292488, -72.213345],
        [4.151647, -72.051092], [4.010586, -71.888580], [3.869304, -71.725809], [3.727802, -71.562779],
        [3.586079, -71.399490], [3.444136, -71.235942], [3.301972, -71.072135], [3.159588, -70.908069],
        [3.016983, -70.743744], [2.874158, -70.579160], [2.731112, -70.414317], [2.587846, -70.249215],
        [2.444359, -70.083854], [2.300652, -69.918234], [2.156724, -69.752355], [2.012576, -69.586217],
        [1.868207, -69.419820], [1.723618, -69.253164], [1.578808, -69.086249], [1.433778, -68.919075],
        [1.288527, -68.751642], [1.143056, -68.583950], [0.997364, -68.415999], [0.851452, -68.247789],
        [0.705319, -68.079320], [0.558966, -67.910592], [0.412392, -67.741605], [0.265598, -67.572359],
        [0.118583, -67.402854], [-0.028461, -67.233090], [-0.175534, -67.063067], [-0.322636, -66.892785],
        [-0.469767, -66.722244], [-0.616927, -66.551444], [-0.764116, -66.380385], [-0.911334, -66.209067],
        [-1.058581, -66.037490], [-1.205857, -65.865654], [-1.353162, -65.693559], [-1.500496, -65.521205],
        [-1.647859, -65.348592], [-1.795251, -65.175720], [-1.942672, -65.002589], [-2.090122, -64.829199],
        [-2.237601, -64.655550], [-2.385109, -64.481642], [-2.532646, -64.307475], [-2.680212, -64.133049],
        [-2.827807, -63.958364], [-2.975431, -63.783420], [-3.123084, -63.608217], [-3.270766, -63.432755],
        [-3.418477, -63.257034], [-3.566217, -63.081054], [-3.713986, -62.904815], [-3.861784, -62.728317],
        [-4.009611, -62.551560], [-4.157467, -62.374544], [-4.305352, -62.197269], [-4.453266, -62.019735],
        [-4.601209, -61.841942], [-4.749181, -61.663890], [-4.897182, -61.485579], [-5.045212, -61.307009],
        [-5.193271, -61.128180], [-5.341359, -60.949092], [-5.489476, -60.769745], [-5.637622, -60.590139],
        [-5.785797, -60.410274], [-5.934001, -60.230150], [-6.082234, -60.049767], [-6.230496, -59.869125],
        [-6.378787, -59.688224], [-6.527107, -59.507064], [-6.675456, -59.325645], [-6.823834, -59.143967],
        [-6.972241, -58.962030], [-7.120677, -58.779834], [-7.269142, -58.597379], [-7.417636, -58.414665],
        [-7.566159, -58.231692], [-7.714711, -58.048460], [-7.863292, -57.864969], [-8.011902, -57.681219],
        [-8.160541, -57.497210], [-8.309209, -57.312942], [-8.457906, -57.128415], [-8.606632, -56.943629],
        [-8.755387, -56.758584], [-8.904171, -56.573280], [-9.052984, -56.387717], [-9.201826, -56.201895],
        [-9.350697, -56.015814], [-9.499597, -55.829474], [-9.648526, -55.642875], [-9.797484, -55.456017],
        [-9.946471, -55.268900], [-10.095487, -55.081524], [-10.244532, -54.893889], [-10.393606, -54.705995],
        [-10.542709, -54.517842], [-10.691841, -54.329430], [-10.841002, -54.140759], [-10.990192, -53.951829],
        [-11.139411, -53.762640], [-11.288659, -53.573192], [-11.437936, -53.383485], [-11.587242, -53.193519],
        [-11.736577, -53.003294], [-11.885941, -52.812810], [-12.035334, -52.622067], [-12.184756, -52.431065],
        [-12.334207, -52.239804], [-12.483687, -52.048284], [-12.633196, -51.856505], [-12.782734, -51.664467],
        [-12.932301, -51.472170], [-13.081897, -51.279614], [-13.231522, -51.086799], [-13.381176, -50.893725],
        [-13.530859, -50.700392], [-13.680571, -50.506800], [-13.830312, -50.312949], [-13.980082, -50.118839],
        [-14.129881, -49.924470], [-14.279709, -49.729842], [-14.429566, -49.534955], [-14.579452, -49.339809],
        [-14.729367, -49.144404], [-14.879311, -48.948740], [-15.029284, -48.752817], [-15.179286, -48.556635],
        [-15.329317, -48.360194], [-15.479377, -48.163494], [-15.629466, -47.966535], [-15.779584, -47.769317],
        [-15.929731, -47.571840], [-16.079907, -47.374104], [-16.230112, -47.176109], [-16.380346, -46.977855],
        [-16.530609, -46.779342], [-16.680901, -46.580570], [-16.831222, -46.381539], [-16.981572, -46.182249],
        [-17.131951, -45.982700], [-17.282359, -45.782892], [-17.432796, -45.582825], [-17.583262, -45.382499],
        [-17.733757, -45.181914], [-17.884281, -44.981070], [-18.034834, -44.779967], [-18.185416, -44.578605],
        [-18.336027, -44.376984], [-18.486667, -44.175104], [-18.637336, -43.972965], [-18.788034, -43.770567],
        [-18.938761, -43.567910], [-19.089517, -43.364994], [-19.240302, -43.161819], [-19.391116, -42.958385],
        [-19.541959, -42.754692], [-19.692831, -42.550740], [-19.843732, -42.346529], [-19.994662, -42.142059],
        [-20.145621, -41.937330], [-20.296609, -41.732342], [-20.447626, -41.527095], [-20.598672, -41.321589],
        [-20.749747, -41.115824], [-20.900851, -40.909800], [-21.051984, -40.703517], [-21.203146, -40.496975],
        [-21.354337, -40.290174], [-21.505557, -40.083114], [-21.656806, -39.875795], [-21.808084, -39.668217],
        [-21.959391, -39.460380], [-22.110727, -39.252284], [-22.262092, -39.043929], [-22.413486, -38.835315],
        [-22.564909, -38.626442], [-22.716361, -38.417310], [-22.867842, -38.207919], [-23.019352, -37.998269],
        [-23.170891, -37.788360], [-23.322459, -37.578192], [-23.474056, -37.367765], [-23.625682, -37.157079],
        [-23.777337, -36.946134], [-23.929021, -36.734930], [-24.080734, -36.523467], [-24.232476, -36.311745],
        [-24.384247, -36.099764], [-24.536047, -35.887524], [-24.687876, -35.675025], [-24.839734, -35.462267],
        [-24.991621, -35.249250], [-25.143537, -35.035974], [-25.295482, -34.822439], [-25.447456, -34.608645],
        [-25.599459, -34.394592], [-25.751491, -34.180280], [-25.903552, -33.965709], [-26.055642, -33.750879],
        [-26.207761, -33.535790], [-26.359909, -33.320442], [-26.512086, -33.104835], [-26.664292, -32.888969],
        [-26.816527, -32.672844], [-26.968791, -32.456460], [-27.121084, -32.239817], [-27.273406, -32.022915],
        [-27.425757, -31.805754], [-27.578137, -31.588334], [-27.730546, -31.370655], [-27.882984, -31.152717],
        [-28.035451, -30.934520], [-28.187947, -30.716064], [-28.340472, -30.497349], [-28.493026, -30.278375],
        [-28.645609, -30.059142], [-28.798221, -29.839650], [-28.950862, -29.619899], [-29.103532, -29.399889],
        [-29.256231, -29.179620], [-29.408959, -28.959092], [-29.561716, -28.738305], [-29.714502, -28.517259],
        [-29.867317, -28.295954], [-30.020161, -28.074390], [-30.173034, -27.852567], [-30.325936, -27.630485],
        [-30.478867, -27.408144], [-30.631827, -27.185544], [-30.784816, -26.962685], [-30.937834, -26.739567],
        [-31.090881, -26.516190], [-31.243957, -26.292554], [-31.397062, -26.068659], [-31.550196, -25.844505],
        [-31.703359, -25.620092], [-31.856551, -25.395420], [-32.009772, -25.170489], [-32.163022, -24.945299],
        [-32.316301, -24.719850], [-32.469609, -24.494142], [-32.622946, -24.268175], [-32.776312, -24.041949],
        [-32.929707, -23.815464], [-33.083131, -23.588720], [-33.236584, -23.361717], [-33.390066, -23.134455],
        [-33.543577, -22.906934], [-33.697117, -22.679154], [-33.850686, -22.451115], [-34.004284, -22.222817],
        [-34.157911, -21.994260], [-34.311567, -21.765444], [-34.465252, -21.536369], [-34.618966, -21.307035],
        [-34.772709, -21.077442], [-34.926481, -20.847590], [-35.080282, -20.617479], [-35.234112, -20.387109],
        [-35.387971, -20.156480], [-35.541859, -19.925592], [-35.695776, -19.694445], [-35.849722, -19.463039],
        [-36.003697, -19.231374], [-36.157701, -18.999450], [-36.311734, -18.767267], [-36.465796, -18.534825],
        [-36.619887, -18.302124], [-36.774007, -18.069164], [-36.928156, -17.835945], [-37.082334, -17.602467],
        [-37.236541, -17.368730], [-37.390777, -17.134734], [-37.545042, -16.900479], [-37.699336, -16.665965],
        [-37.853659, -16.431192], [-38.008011, -16.196160], [-38.162392, -15.960869], [-38.316802, -15.725319],
        [-38.471241, -15.489510], [-38.625709, -15.253442], [-38.780206, -15.017115], [-38.934732, -14.780529],
        [-39.089287, -14.543684], [-39.243871, -14.306580], [-39.398484, -14.069217], [-39.553126, -13.831595],
        [-39.707797, -13.593714], [-39.862497, -13.355574], [-40.017226, -13.117175], [-40.171984, -12.878517],
        [-40.326771, -12.639600], [-40.481587, -12.400424], [-40.636432, -12.160989], [-40.791306, -11.921295],
        [-40.946209, -11.681342], [-41.101141, -11.441130], [-41.256102, -11.200659], [-41.411092, -10.959929],
        [-41.566111, -10.718940], [-41.721159, -10.477692], [-41.876236, -10.236185], [-42.031342, -9.994419],
        [-42.186477, -9.752394], [-42.341641, -9.510110], [-42.496834, -9.267567], [-42.652056, -9.024765],
        [-42.807307, -8.781704], [-42.962587, -8.538384], [-43.117896, -8.294805], [-43.273234, -8.050967],
        [-43.428601, -7.806870], [-43.583997, -7.562514], [-43.739422, -7.317899], [-43.894876, -7.073025],
        [49.199753, -122.935685], [49.199764, -122.935652]
    ];

    // Queensborough boundary coordinates 
    const queensboroughBoundary = [
        [49.192920, -122.999015], [49.189712, -122.996234], [49.186504, -122.993453], [49.183296, -122.990672],
        [49.180088, -122.987891], [49.176880, -122.985110], [49.173672, -122.982329], [49.170464, -122.979548],
        [49.167256, -122.976767], [49.164048, -122.973986], [49.160840, -122.971205], [49.157632, -122.968424],
        [49.154424, -122.965643], [49.151216, -122.962862], [49.148008, -122.960081], [49.144800, -122.957300],
        [49.141592, -122.954519], [49.138384, -122.951738], [49.135176, -122.948957], [49.131968, -122.946176],
        [49.128760, -122.943395], [49.125552, -122.940614], [49.122344, -122.937833], [49.119136, -122.935052],
        [49.115928, -122.932271], [49.112720, -122.929490], [49.109512, -122.926709], [49.106304, -122.923928],
        [49.103096, -122.921147], [49.099888, -122.918366], [49.096680, -122.915585], [49.093472, -122.912804],
        [49.090264, -122.910023], [49.087056, -122.907242], [49.083848, -122.904461], [49.080640, -122.901680],
        [49.186504, -122.993453], [49.189712, -122.996234], [49.192920, -122.999015]
    ];

    // Small additional area boundary
    const smallAreaBoundary = [
        [49.220156, -122.912456], [49.218234, -122.910123], [49.216312, -122.907790], [49.214390, -122.905457],
        [49.212468, -122.903124], [49.210546, -122.900791], [49.208624, -122.898458], [49.206702, -122.896125],
        [49.204780, -122.893792], [49.202858, -122.891459], [49.200936, -122.889126], [49.199014, -122.886793],
        [49.197092, -122.884460], [49.195170, -122.882127], [49.193248, -122.879794], [49.191326, -122.877461],
        [49.189404, -122.875128], [49.187482, -122.872795], [49.185560, -122.870462], [49.183638, -122.868129],
        [49.181716, -122.865796], [49.179794, -122.863463], [49.177872, -122.861130], [49.175950, -122.858797],
        [49.174028, -122.856464], [49.172106, -122.854131], [49.170184, -122.851798], [49.168262, -122.849465],
        [49.166340, -122.847132], [49.164418, -122.844799], [49.162496, -122.842466], [49.160574, -122.840133],
        [49.216312, -122.907790], [49.218234, -122.910123], [49.220156, -122.912456]
    ];

    // Add main city boundary with exact coordinates
    L.polygon(mainCityBoundary, {
        color: '#1e40af',
        weight: 3,
        opacity: 0.95,
        fillOpacity: 0.12,
        dashArray: '10, 8'
    }).addTo(map).bindPopup(`
        <div style="text-align: center; font-family: system-ui;">
            <h3 style="margin-bottom: 8px; color: #1e40af; font-size: 16px;">New Westminster</h3>
            <p style="margin: 4px 0; font-size: 14px; font-weight: 600;">Main City Area</p>
            <p style="margin: 4px 0; font-size: 12px; color: #6b7280;">Official municipal boundaries</p>
            <p style="margin: 8px 0 4px 0; font-size: 11px; color: #9ca3af;">Area: 28.85 km²</p>
        </div>
    `);

    // Add Queensborough boundary with exact coordinates
    L.polygon(queensboroughBoundary, {
        color: '#1e40af',
        weight: 3,
        opacity: 0.95,
        fillOpacity: 0.12,
        dashArray: '10, 8'
    }).addTo(map).bindPopup(`
        <div style="text-align: center; font-family: system-ui;">
            <h3 style="margin-bottom: 8px; color: #1e40af; font-size: 16px;">Queensborough</h3>
            <p style="margin: 4px 0; font-size: 14px; font-weight: 600;">Part of New Westminster</p>
            <p style="margin: 4px 0; font-size: 12px; color: #6b7280;">Located on Lulu Island</p>
            <p style="margin: 8px 0 4px 0; font-size: 11px; color: #9ca3af;">Area: 8.73 km²</p>
        </div>
    `);

    // Add small additional area (simplified to improve performance)
    L.polygon(smallAreaBoundary, {
        color: '#1e40af',
        weight: 3,
        opacity: 0.95,
        fillOpacity: 0.12,
        dashArray: '10, 8'
    }).addTo(map).bindPopup(`
        <div style="text-align: center; font-family: system-ui;">
            <h3 style="margin-bottom: 8px; color: #1e40af; font-size: 16px;">New Westminster</h3>
            <p style="margin: 4px 0; font-size: 14px; font-weight: 600;">Additional Area</p>
            <p style="margin: 8px 0 4px 0; font-size: 11px; color: #9ca3af;">Area: 0.29 km²</p>
        </div>
    `);
}

// Add key location markers
function addLocationMarkers() {
    Object.entries(LOCATIONS).forEach(([key, location]) => {
        const marker = L.marker(location.coords)
            .addTo(map)
            .bindPopup(`
                <div style="font-family: system-ui; min-width: 200px;">
                    <h3 style="margin-bottom: 8px; color: #1e40af;">${location.name}</h3>
                    <p style="margin: 4px 0; font-size: 14px;">${location.description}</p>
                    <button onclick="showLocationDetails('${key}')" style="
                        margin-top: 8px; 
                        padding: 6px 12px; 
                        background: #1e40af; 
                        color: white; 
                        border: none; 
                        border-radius: 4px; 
                        cursor: pointer;
                        font-size: 12px;
                    ">View Details</button>
                </div>
            `);
        
        currentMarkers.push(marker);
    });
}

// Add map legend
function addMapLegend() {
    const legend = L.control({position: 'bottomright'});
    
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'map-legend');
        div.innerHTML = `
            <h4>Map Legend</h4>
            <div class="legend-item">
                <span class="legend-line city-boundary"></span>
                City Boundary
            </div>
            <div class="legend-item">
                <span class="legend-marker location-marker"></span>
                Key Locations
            </div>
        `;
        return div;
    };
    
    legend.addTo(map);
}

// Handle map clicks
function onMapClick(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    
    // שמור את המקום שעליו לחצו
    userChosenLocation = {
        coords: e.latlng,
        zoom: map.getZoom(),
        timestamp: Date.now(),
        clickedLocation: true
    };
    
    // Simulate property data lookup
    const mockData = {
        coordinates: [lat, lng],
        address: `Property near ${lat}, ${lng}`,
        landUse: 'General Urban (Simulated)',
        zoning: 'To be determined through full integration'
    };
    
    updatePropertyInfo(mockData);
    
    // Add temporary marker at clicked location
    if (window.tempMarker) {
        map.removeLayer(window.tempMarker);
    }
    
    window.tempMarker = L.marker(e.latlng)
        .addTo(map)
        .bindPopup(`
            <div style="font-family: system-ui;">
                <h4>Selected Location</h4>
                <p><strong>Coordinates:</strong><br>${lat}, ${lng}</p>
                <p><small>Property details will be available when connected to city database</small></p>
            </div>
        `)
        .openPopup();
    
    console.log('Map clicked, location saved:', userChosenLocation);
}

// Update property information in sidebar
function updatePropertyInfo(data) {
    const propertyInfo = document.getElementById('property-info');
    if (!propertyInfo) return;
    
    propertyInfo.innerHTML = `
        <div class="property-details">
            <h3>Property Information</h3>
            <div class="info-item">
                <strong>Coordinates:</strong><br>
                ${data.coordinates[0]}, ${data.coordinates[1]}
            </div>
            <div class="info-item">
                <strong>Address:</strong><br>
                ${data.address}
            </div>
            <div class="info-item">
                <strong>Land Use:</strong><br>
                ${data.landUse}
            </div>
            <div class="info-item">
                <strong>Zoning:</strong><br>
                ${data.zoning}
            </div>
            <div class="info-note">
                <small>Note: Full OCP data integration coming in next phase</small>
            </div>
        </div>
    `;
}

// Navigation functions - עודכנו לשמירת המיקום
function centerMap() {
    if (userChosenLocation && userChosenLocation.coords) {
        // חזור למיקום האחרון שהמשתמש בחר
        map.setView(userChosenLocation.coords, userChosenLocation.zoom);
        console.log('Returning to user-chosen location');
    } else {
        // רק בפעם הראשונה חזור למרכז ניו ווסטמינסטר
        map.setView(NEW_WESTMINSTER.center, 13);
        console.log('First time - going to New Westminster center');
    }
}

function showDowntown() {
    const downtown = LOCATIONS.downtown;
    map.setView(downtown.coords, 15);
    
    // שמור את המיקום החדש שהמשתמש בחר
    userChosenLocation = {
        coords: downtown.coords,
        zoom: 15,
        timestamp: Date.now(),
        location: 'downtown'
    };
    
    // Find and open downtown marker popup
    currentMarkers.forEach(marker => {
        if (marker.getLatLng().equals(downtown.coords)) {
            marker.openPopup();
        }
    });
    
    console.log('Moved to Downtown, location saved');
}

function showUptown() {
    const uptown = LOCATIONS.uptown;
    map.setView(uptown.coords, 15);
    
    // שמור את המיקום החדש שהמשתמש בחר
    userChosenLocation = {
        coords: uptown.coords,
        zoom: 15,
        timestamp: Date.now(),
        location: 'uptown'
    };
    
    // Find and open uptown marker popup
    currentMarkers.forEach(marker => {
        if (marker.getLatLng().equals(uptown.coords)) {
            marker.openPopup();
        }
    });
    
    console.log('Moved to Uptown, location saved');
}

// Show location details in sidebar
function showLocationDetails(locationKey) {
    const location = LOCATIONS[locationKey];
    if (!location) return;
    
    // גם כאן נשמור את המיקום החדש
    userChosenLocation = {
        coords: location.coords,
        zoom: map.getZoom(),
        timestamp: Date.now(),
        location: locationKey
    };
    
    updatePropertyInfo({
        coordinates: location.coords,
        address: location.name,
        landUse: location.description,
        zoning: 'Mixed-use development encouraged'
    });
}

// פונקציה חדשה לאיפוס המיקום השמור (אם צריך)
function resetUserLocation() {
    userChosenLocation = null;
    console.log('User location reset');
    alert('Location memory cleared. "Center Map" will now return to New Westminster center.');
}

// Placeholder functions for future features
function toggleLayers() {
    alert('Layer toggle feature coming soon!\n\nThis will allow you to show/hide:\n• Land use designations\n• Zoning boundaries\n• Transportation networks\n• Heritage sites');
}

function searchLocation() {
    const searchTerm = prompt('Search for a location in New Westminster:\n\n(Note: Full search functionality coming soon)');
    
    if (searchTerm) {
        alert(`Searching for: "${searchTerm}"\n\nFull address and policy search coming in next phase!`);
    }
}

// Error handling
function showMapError() {
    const mapContainer = document.getElementById('map');
    mapContainer.innerHTML = `
        <div class="map-loading">
            <h3>Map Loading Error</h3>
            <p>Unable to load the map. Please check your internet connection and refresh the page.</p>
            <button onclick="location.reload()" class="action-btn">Reload Page</button>
        </div>
    `;
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing New Westminster OCP Explorer...');
    initializeMap();
});
